import{initCustomDataTable}from"../DataTable/datatables-init.js";let debounceTimer,table;const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});$(document).ready((function(){$("#role").attr("role");table=initCustomDataTable("#tabla-conceptos",BASE_URL+"api/recibos.php?tipo=tabla_conceptos&id_recibo=null&tipo_filtro=nuevo_recibo",[{data:null,title:"#",class:"text-center"},{data:"concepto",title:"Concepto"},{data:"cantidad",title:"Cantidad",class:"text-center"},{data:"precio_unitario",title:"Precio unitario",class:"text-end"},{data:"importe",title:"Importe",class:"text-end"},{data:null,title:"Opciones",class:"text-center",render:function(e,a,o){return"\n            <div class='row'>\n              <div class='col-12 col-md-12 text-center'>\n                <div class=\"btn btn-danger btn-eliminar-concepto\">\n                  <i class=\"fa-solid fa-trash\"></i>\n                </div>\n              </div>\n            </div>"}}],[0,"desc"])})),$(document).on("change","#alumno",(function(){""!=$(this).val()&&estilizarBordes("alumno","",!0)})),$(document).on("change","#tipo",(function(){""!=$(this).val()&&estilizarBordes("tipo","",!0)}));let ultimaBusqueda="";function buscarAlumno(e){$.ajax({type:"post",url:BASE_URL+"api/alumnos.php?tipo=combo",data:{busqueda:e},dataType:"json",success:function(e){e.estatus&&($("#alumno").empty(),e.data.forEach((e=>{$("#alumno").append(`<option value="${e.id}">${e.nombre+" "+e.apellido_paterno+" "+e.apellido_materno}</option>`)})),$("#alumno").selectpicker("refresh"))}})}function setearTipo(e){1==e.target.value?($("#area-plazo").empty(),$("#label-forma-pago").text("Forma(s) de pago ")):($("#area-plazo").append('\n    <div class="col-12 col-md-4">\n        <label for="plazo">Plazo</label>\n        <select id="plazo" class="form-control selectpicker">\n            <option value="1">7 dias</option>\n            <option value="2">15 dias</option>\n            <option value="3" selected>1 mes</option>\n            <option value="4">45 días</option>\n            <option value="5">1 día</option>\n            <option value="6">Personalizada</option>\n        </select>\n    </div>\n    '),$("#label-forma-pago").text("Forma(s) de pago del adelanto"),$("#plazo").selectpicker("refresh"))}function setearFormaPago(){let e=$("#forma-pago").val(),a=$("#area-formas-pago");$("#suma_total").val(""),a.empty(),e.length>0?(a.append('\n        <label><b>Montos de la forma de pago</b></label><br>\n        <div class="row mt-3" id="lista-formas-pago"></div>'),e.forEach((e=>{$("#lista-formas-pago").append(`\n                <div class="col-12 col-md-6 mb-2">\n                    <div class="row mb-1" style="vertical-align:middle !important;">\n                        <div class="col-1">\n                            <img src="${BASE_URL}static/img/formas_pago/${e}.png" style="width: 30px">\n                        </div>\n                        <div class="col-10" style="margin-left: 7px; vertical-align:middle !important;">\n                            <label>${e}</label>\n                        </div>\n                    </div>\n                    <input class="form-control input-forma-pago" id="f_${e}" type="number" placeholder="0.00">\n                </div>\n            `)})),estilizarBordes("forma-pago","",!0)):(estilizarBordes("forma-pago","Selecciona al menos una forma de pago",!1),a.append('\n        <label><b>Montos de la forma de pago</b></label><br>\n\n        <div class="row mt-3" id="lista-formas-pago">\n            <div class="col-12 col-md-12 text-start">\n                Sin formas de pago seleccionadas\n           </div>\n        </div>\n        '))}function setearCategoria(){let e=$("#categoria").val();e&&estilizarBordes("categoria","",!0);let a=$("#area-categoria");1==e?(a.append('\n      <div class="col-12 col-md-6">\n          <label for="mes">Mes</label>\n          <select id="mes" class="form-control selectpicker"\n              placeholder="Selecciona una mensualidad"\n              data-live-search="true">\n              <option value="1">Enero</option>\n              <option value="2">Febrero</option>\n              <option value="3">Marzo</option>\n              <option value="4">Abril</option>\n              <option value="5">Mayo</option>\n              <option value="6">Junio</option>\n              <option value="7">Julio</option>\n              <option value="8">Agosto</option>\n              <option value="9">Septiembre</option>\n              <option value="10">Octubre</option>\n              <option value="11">Noviembre</option>\n              <option value="12">Diciembre</option>\n          </select>\n          <small id="small_mes" style="color:tomato;"></small>\n\n      </div>\n  \n      <div class="col-12 col-md-6">\n          <label for="">Año</label>\n          <select id="year" class="form-control selectpicker"\n              placeholder="Selecciona un año"\n              data-live-search="true">\n              <option value="2024">2024</option>\n              <option value="2025" selected>2025</option>\n          </select>\n          <small id="small_year" style="color:tomato;"></small>\n\n      </div>\n      '),$("#mes").selectpicker("refresh"),$("#year").selectpicker("refresh")):a.empty()}function setearMonto(e){let a=document.getElementById("area-formas-pago").querySelectorAll('input[type="number"]'),o=parseFloat($("#importe_total").val()),t=$("#tipo").val(),n=0;a.forEach((e=>{let a=parseFloat(e.value)||0;n+=parseFloat(a)})),$("#suma_total").val(n),1==t?n!=o?estilizarBordes("suma_total","La suma no coincide con el total.",!1):(estilizarBordes("suma_total","",!0),estilizarBordes("area-formas-pago","",!0)):n>=0&&n<=o?(estilizarBordes("suma_total","",!0),estilizarBordes("area-formas-pago","",!0)):estilizarBordes("suma_total","La suma no puede ser menor a 0 o mayor que el total.",!1)}function agregarConcepto(){if(verificarCampos(1)){let e=$("#categoria").val(),a=$("#cantidad").val(),o=$("#precio").val(),t="",n="";1==e&&(t=$("#year").val(),n=$("#mes").val()),$.ajax({type:"post",url:BASE_URL+"api/recibos.php?tipo=agregar_concepto",data:{cantidad:a,categoria:e,precio:o,mensualidad:n,year:t},dataType:"json",success:function(e){e.estatus?(Toast.fire({icon:"success",title:e.mensaje}),$("#importe_total").val(e.data.suma)):Toast.fire({icon:"warning",title:e.mensaje}),table.ajax.reload(null,!1)}})}}function eliminarConcepto(e){$.ajax({type:"post",url:BASE_URL+"api/recibos.php?tipo=eliminar_concepto",data:{id:e},dataType:"json",success:function(e){e.estatus?(Toast.fire({icon:"success",title:e.mensaje}),$("#importe_total").val(e.data.suma)):Toast.fire({icon:"warning",title:e.mensaje}),table.ajax.reload(null,!1)}})}function verificarCampos(e){if(1==e){let e=$("#categoria").val(),a=$("#cantidad").val(),o=$("#precio").val();if(!e)return Toast.fire({icon:"warning",title:"Selecciona una categoria"}),estilizarBordes("categoria","Selecciona una categoria.",!1),!1;if(!a)return Toast.fire({icon:"warning",title:"Ingresa una cantidad"}),estilizarBordes("cantidad","Ingresa una cantidad.",!1),!1;if(a<=0)return Toast.fire({icon:"warning",title:"La cantidad no puede ser igual o menor que 0"}),estilizarBordes("cantidad","La cantidad no puede ser igual o menor que 0",!1),!1;if(!o)return Toast.fire({icon:"warning",title:"Ingresa un monto"}),estilizarBordes("precio","Ingresa un monto.",!1),!1;if(a<0)return Toast.fire({icon:"warning",title:"La cantidad no puede ser menor que 0"}),estilizarBordes("precio","La cantidad no puede ser menor que 0",!1),!1;if(1==e){let e=$("#mes").val(),a=$("#year").val();if(!e)return Toast.fire({icon:"warning",title:"Selecciona una mensualidad"}),estilizarBordes("mes","Selecciona una mensualidad.",!1),!1;if(!a)return Toast.fire({icon:"warning",title:"Selecciona un año"}),estilizarBordes("year","Selecciona un año.",!1),!1}return!0}if(2==e){let e=$("#alumno").val(),a=$("#tipo").val(),o=$("#forma-pago").val(),t=$("#suma_total").val(),n=$("#importe_total").val();if(!e)return Toast.fire({icon:"warning",title:"Selecciona un alumno"}),estilizarBordes("alumno","Selecciona un alumno.",!1),!1;if(!a)return Toast.fire({icon:"warning",title:"Selecciona un tipo de recibo"}),estilizarBordes("tipo","Selecciona un tipo de recibo.",!1),!1;if(0==o.length)return Toast.fire({icon:"warning",title:"Selecciona al menos una forma de pago"}),estilizarBordes("forma-pago","Selecciona una forma de pago.",!1),!1;if(o){let e=!0,i="";return o.forEach((a=>{$("#f_"+a).val()||(e=!1,""!=i&&(i+=", "),i+=a)})),e?1!=a||(n=parseFloat(n),t=parseFloat(t),n==t)||(Toast.fire({icon:"warning",title:"La suma no coincide con el total "+i}),estilizarBordes("suma_total","La suma no coincide con el total.",!1),!1):(Toast.fire({icon:"warning",title:"Ingresa la forma de pago: "+i}),estilizarBordes("area-formas-pago","Ingresa la forma de pago.",!1),!1)}}}function estilizarBordes(e,a,o){if(o){$(`#${e}`).css("border","1px solid #59de64");let a=$(`#${e}`).next();a.is("small")||a.removeClass("border-red").addClass("border-success")}else{$(`#${e}`).css("border","1px solid red");let a=$(`#${e}`).next();a.is("small")||a.removeClass("border-success").addClass("border-red")}$(`#small_${e}`).text(a),$(`#${e}`).selectpicker("refresh")}function comprobacionKeyups(e,a){if("cantidad"==e){if(!a.target.value)return estilizarBordes(e,"Ingresa una cantidad.",!1),!0;if(a.target.value<=0)return estilizarBordes(e,"La cantidad no puede ser igual o menor que 0.",!1),!0;estilizarBordes(e,"",!0)}else if("precio"==e){if(!a.target.value)return estilizarBordes(e,"Ingresa un monto.",!1),!0;if(a.target.value<0)return estilizarBordes(e,"El monto no puede menor que 0.",!1),!0;estilizarBordes(e,"",!0)}else estilizarBordes(e,"",!0)}function hacerRecibo(){const e=document.getElementById("btn-hacer-recibo");if(e.disabled=!0,e.textContent="Realizando...",verificarCampos(2)){const a=new FormData;let o=$("#alumno").val(),t=$("#tipo").val(),n=$("#plazo").val()?parseInt($("#plazo").val()):0,i=$("#comentarios").val(),r=$("#ciclo").val();a.append("alumno",o),a.append("tipo_recibo",t),a.append("ciclo",r),a.append("plazo",n),a.append("comentarios",i);let l=$("#forma-pago").val();a.append("formas_pago",l),l.length>0&&l.forEach((e=>{let o=$("#f_"+e).val();a.append(e,o)})),$.ajax({type:"post",processData:!1,contentType:!1,url:BASE_URL+"api/recibos.php?tipo=generar_recibo",data:a,dataType:"json",success:function(e){e.estatus?(window.open("./recibos/pdf/"+e.data.id_recibo,"_blank"),Swal.fire({icon:"success",title:e.mensaje,confirmButtonText:"Entendido"})):Swal.fire({icon:"error",title:e.mensaje,confirmButtonText:"Entendido"})}}).always((function(){e.disabled=!1,e.textContent="Realizar pago"}))}else e.disabled=!1,e.textContent="Realizar pago"}$("#alumno").on("shown.bs.select",(function(){$(".bs-searchbox input").off("input.miEvento").on("input.miEvento",(function(e){if(e.keyCode>=37&&e.keyCode<=40)return;clearTimeout(debounceTimer);const a=$(this).val().trim();a&&a!==ultimaBusqueda&&(debounceTimer=setTimeout((()=>{ultimaBusqueda=a,buscarAlumno(a)}),400))}))})),$(document).on("change","#mes",(function(){""!=$(this).val()&&estilizarBordes("mes","",!0)})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("tipo"),a=document.getElementById("categoria"),o=document.getElementById("forma-pago"),t=document.getElementById("area-formas-pago"),n=document.getElementById("btn-agregar-concepto"),i=$("#tabla-conceptos"),r=document.getElementById("btn-hacer-recibo");e&&e.addEventListener("change",setearTipo),a&&a.addEventListener("change",setearCategoria),o&&o.addEventListener("change",setearFormaPago),n&&n.addEventListener("click",agregarConcepto),r&&r.addEventListener("click",hacerRecibo),t&&t.addEventListener("keyup",(e=>{e.target.matches(".input-forma-pago")&&setearMonto(e)})),i.on("click",".btn-eliminar-concepto",(function(e){const a=$(this),o=table.row(a.parents("tr")).data();o&&o.id?eliminarConcepto(o.id):console.error("No se pudo obtener el ID del concepto.")})),document.addEventListener("keyup",(e=>{if(e.target.matches(".input-verificacion")){comprobacionKeyups(e.target.id,e)}}))}));