import{initCustomDataTable}from"../DataTable/datatables-init.js";import{formatearFechaEspanol}from"../utils/dates.js";import{DataTableListener,GeneralEventListener}from"../utils/listeners.js";import{cancelarPago}from"./pagos.js";let tabla_conceptos,tabla_pagos,debounceTimer,datos_recibo;function cambioPlazo(){const e=$("#plazo");if(7==e.val())$("#fecha-vencimiento").prop("disabled",!1);else{$("#fecha-vencimiento").prop("disabled",!0);const t=$("#fecha").val();if(!t)return;const a=new Date(t);switch(e.val()){case"1":a.setDate(a.getDate()+7);break;case"2":a.setDate(a.getDate()+15);break;case"3":a.setMonth(a.getMonth()+1);break;case"4":a.setDate(a.getDate()+45);break;case"5":a.setDate(a.getDate()+1);break;case"7":return void console.log("Plazo personalizado seleccionado")}const o=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}T${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`;$("#fecha-vencimiento").val(o)}}function formatearCantidad(e){if(!e||0===e||"0"===e)return"-";const t=parseFloat(e);return isNaN(t)?"-":t.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2})}$(document).ready((function(){GeneralEventListener("tipo","change",t),GeneralEventListener("btn-actualizar-recibo","click",actualizarDatosRecibo);const e=[{data:null,title:"#"},{data:null,title:"Monto",render:e=>{const t=formatearCantidad(e.total);let a;return a=e.total>0?`<b>${t}</b>`:`<span style="color: #828282">${t}<span>`,a}},{data:null,title:"Fecha - hora",render:e=>{const t=new Date(e.fecha);return formatearFechaEspanol(t)}},{data:null,title:"Efect. üíµ",render:e=>{const t=formatearCantidad(e.pago_efectivo);let a;return a=e.pago_efectivo>0?`<b>${t}</b>`:`<span style="color: #828282">${t}<span>`,a}},{data:null,title:"Tarj. üí≥",render:e=>{const t=formatearCantidad(e.pago_tarjeta);let a;return a=e.pago_tarjeta>0?`<b>${t}</b>`:`<span style="color: #828282">${t}<span>`,a}},{data:null,title:"Transf. üì≤",render:e=>{const t=formatearCantidad(e.pago_transferencia);let a;return a=e.pago_transferencia>0?`<b>${t}</b>`:`<span style="color: #828282">${t}<span>`,a}},{data:null,title:"Depost. üèõÔ∏è",render:e=>{const t=formatearCantidad(e.pago_deposito);let a;return a=e.pago_deposito>0?`<b>${t}</b>`:`<span style="color: #828282">${t}<span>`,a}},{data:null,title:"Cheque üìÉ",render:e=>{const t=formatearCantidad(e.pago_cheque);let a;return a=e.pago_cheque>0?`<b>${t}</b>`:`<span style="color: #828282">${t}<span>`,a}},{data:null,title:"Estatus",render:function(e){let t;return t=1==e.estatus?'<span class="badge bg-success">Activo</span>':'<span class="badge bg-secondary">Cancelado</span>',t}},{data:null,title:"Tipo",render:function(e){let t;return t=2==e.estatus?'<span class="badge bg-success">Liquidaci√≥n</span>':'<span class="badge bg-info">Normal</span>',t}},{data:"comentarios",title:"Comentarios"},{data:null,title:"Opciones",render:function(e){let t=e.estatus?1:2,a=e.estatus?"fa-ban":"fa-rotate-left",o=e.estatus?"btn-primary":"btn-secondary",n=e.estatus?"":"disabled",i=e.estatus?"btn-warning":"btn-info",s=e.estatus?"Cancelar pago":"Descancelar pago";return`\n             <div class='row'>\n               <div class='col-12 col-md-12'>\n                 <div class="btn btn-sm" style="background-color:tomato; color:white;" onclick="mostrarReciboPago(${e.id})">\n                   <i class="fa-solid fa-file-pdf"></i>\n                 </div>\n                 <div class="btn ${o} btn-sm ${n}" onclick="editarPago(${e.id}, false)">\n                    <i class="fa-solid fa-pen-to-square"></i>\n                 </div>\n                 <div class="btn ${i} btn-sm btn-cancelar-pago" onclick="cancelarPago(${e.id}, ${t})" alt="${s}">\n                   <i class="fa-solid ${a}"></i>\n                 </div>\n               </div>\n             </div>`}}];function t(){let e=document.getElementById("tipo").value,t=$("#area-fechas");if(2==e){t.empty().append('\n        <div class="col-12 col-md-3">\n            <label for="">Plazo</label>\n            <select name="" id="plazo"\n                class="form-control selectpicker"\n                data-live-search="true">\n                <option value="">Seleccione un plazo</option>\n                <option value="1">7 dias</option>\n                <option value="2">15 dias</option>\n                <option value="3">1 mes</option>\n                <option value="4">45 d√≠as</option>\n                <option value="5">1 d√≠a</option>\n                <option value="7">Personalizado</option>\n            </select>\n        </div>\n        <div class="col-12 col-md-3">\n            <label for="">Fecha</label>\n            <input class="form-control" type="datetime-local" id="fecha">\n        </div>\n        <div class="col-12 col-md-4">\n            <label for="">Fecha de vencimiento</label>\n            <input class="form-control" type="datetime-local" id="fecha-vencimiento" disabled>\n        </div>\n      ');let e=$("#plazo");e.val(datos_recibo.plazo),e.selectpicker("refresh");let a=$("#fecha");const o=new Date(datos_recibo.fecha_registro).toISOString().slice(0,16);a.val(o);let n=$("#fecha-vencimiento");const i=new Date(datos_recibo.fecha_vencimiento).toISOString().slice(0,16);n.val(i),GeneralEventListener("plazo","change",cambioPlazo)}else if(1==e){t.empty().append('\n          <div class="col-12 col-md-3">\n              <label for="">Fecha</label>\n              <input class="form-control" type="datetime-local" id="fecha">\n          </div>\n      ');let e=$("#fecha");const a=new Date(datos_recibo.fecha_registro).toISOString().slice(0,16);e.val(a)}}function a(){$.fn.dataTable.tables(!0).forEach((function(e){var t=$(e).DataTable();t.columns.adjust(),t.responsive&&t.responsive.recalc()}))}tabla_conceptos=initCustomDataTable("#tabla-conceptos-editar",BASE_URL+"api/recibos.php?tipo=tabla_conceptos&id_recibo="+id_recibo+"&tipo_filtro=editar_recibo",[{data:null,title:"#"},{data:"concepto",title:"Conceptos"},{data:"cantidad",title:"Cantidad"},{data:"precio_unitario",title:"Precio Unitario"},{data:"importe",title:"Importe"},{data:null,title:"Opciones",render:function(e){return`\n              <div class='row'>\n                <div class='col-12 col-md-12'>\n                  <div class="btn btn-warning" onclick="borrarConcepto(${e.id})">\n                    <i class="fa-solid fa-trash"></i>\n                  </div>\n                </div>\n              </div>`}}]),tabla_pagos=initCustomDataTable("#tabla-pagos",BASE_URL+"api/recibos.php?tipo=tabla_pagos&id_recibo="+id_recibo,e),window.cancelarPago=cancelarPago,$("#alumno").on("shown.bs.select",(function(){$(".bs-searchbox input").off("keyup.miEvento").on("keyup.miEvento",(function(){clearTimeout(debounceTimer);const e=$(this).val().trim();e&&(debounceTimer=setTimeout((()=>{var t;t=e,$.ajax({type:"post",url:BASE_URL+"api/alumnos.php?tipo=combo",data:{busqueda:t},dataType:"json",success:function(e){e.estatus&&($("#alumno").empty(),e.data.forEach((e=>{$("#alumno").append(`<option value="${e.id}">${e.nombre+" "+e.apellido_paterno+" "+e.apellido_materno}</option>`)})),$("#alumno").selectpicker("refresh"))}})}),400))}))})),async function(e){const a=BASE_URL+"api/recibos.php?tipo=obtener_recibo",o={id_recibo:e};try{const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)throw new Error(`Error HTTP: ${e.mensaje}`);const n=(await e.json()).data;let i=$("#alumno"),s=$("#grupo"),l=$("#tipo"),r=$("#estatus"),c=$("#importe-total"),d=$("#saldo-pendiente"),p=$("#comentarios"),u=$("#total"),m=$("#pagado"),b=$("#restante");if(n&&n.id_alumno){datos_recibo=n;const e=n.id_alumno,a=n.alumno,o=n.grupo,f=n.tipo,v=n.estatus,g=n.monto_total,$=n.saldo_pendiente,h=n.monto_total-n.saldo_pendiente,_=n.comentario;if(0==n.saldo_pendiente&&document.getElementById("btn-nuevo-pago").classList.add("d-none"),0===i.find(`option[value="${e}"]`).length){const t=`<option value="${e}">${a}</option>`;i.append(t)}i.val(e),s.val(o),l.val(f),r.val(v),c.val(g),d.val($),u.val(g),m.val(parseFloat(h)),b.val($),p.val(_),i.selectpicker("refresh"),l.selectpicker("refresh"),r.selectpicker("refresh"),t()}}catch(e){console.error("‚ùå Hubo un problema al enviar los datos:",e.message)}}(id_recibo),window.addEventListener("hashchange",(function(){setTimeout(a,50)})),window.addEventListener("load",(function(){setTimeout(a,50)}))}));export function retornarRecibo(){return datos_recibo}export function estilizarBordes(e,t,a){if(a){$(`#${e}`).css("border","1px solid #59de64");let t=$(`#${e}`).next();t.is("small")||t.removeClass("border-red").addClass("border-success")}else{$(`#${e}`).css("border","1px solid red");let t=$(`#${e}`).next();t.is("small")||t.removeClass("border-success").addClass("border-red")}$(`#small_${e}`).text(t),$(`#${e}`).selectpicker("refresh")}function actualizarDatosRecibo(){const e=document.getElementById("contenedor-ids-recibo").dataset.idRecibo;let t,a=document.getElementById("alumno").value,o=document.getElementById("tipo").value,n=document.getElementById("fecha").value,i=document.getElementById("estatus").value,s=document.getElementById("comentarios").value;t=2==o?document.getElementById("fecha-vencimiento").value:null,$.ajax({type:"post",url:BASE_URL+"api/recibos.php?tipo=actualizar_datos_generales",data:{data:{id_recibo:e,id_alumno:a,tipo:o,fecha:n,estatus:i,comentarios:s,fecha_vencimiento:t}},dataType:"json",success:function(e){const t=e.estatus?"success":"error";Swal.fire({title:e.mensaje,icon:t,confirmButtonText:"Entendido",showCloseButton:!0})}})}export{tabla_pagos};