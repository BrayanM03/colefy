import{initCustomDataTable}from"../DataTable/datatables-init.js";import{GeneralEventListener}from"../utils/listeners.js";let debounceTimer,table;function mostrarRecibo(a){window.open("./recibos/pdf/"+a,"_blank")}function cancelarRecibo(a,e){let t;t=1==e?"¿Deseas cancelar este recibo?":"¿Deseas descancelar este recibo?",Swal.fire({icon:"question",title:t,showCancelButton:!0,cancelButtonText:"No",confirmButtonText:"Si",showCloseButton:!0}).then((t=>{t.isConfirmed&&$.ajax({type:"POST",url:BASE_URL+"api/recibos.php?tipo=actualizar_estatus_recibo",data:{id_recibo:a,tipo_cancelacion:e},dataType:"JSON",success:function(a){1==a.estatus?Swal.fire({icon:"success",html:`\n                      ${a.mensaje}<br>\n                      `,allowOutsideClick:!0,confirmButtonText:"Entendido",showCancelButton:!1}).then((a=>{a.isConfirmed&&table.ajax.reload(!1)})):Swal.fire({icon:"error",html:`\n                      Ocurrio un error: ${a.mensaje}\n                      `,allowOutsideClick:!0,showCancelButton:!1,confirmButtonText:"Entendido"}).then((a=>{a.isConfirmed&&table.ajax.reload(!1)}))}})}))}function editarRecibo(a,e){window.open(BASE_URL+"recibos/editar/"+a,"_blank")}function buscarAlumno(a){$.ajax({type:"post",url:BASE_URL+"api/alumnos.php?tipo=combo",data:{busqueda:a},dataType:"json",success:function(a){a.estatus&&($("#f-alumno").empty(),a.data.forEach((a=>{$("#f-alumno").append(`<option value="${a.id}">${a.nombre+" "+a.apellido_paterno+" "+a.apellido_materno}</option>`)})),$("#f-alumno").selectpicker("refresh"))}})}$(document).ready((function(){const a={url:BASE_URL+"api/recibos.php?tipo=datatable",type:"POST",data:function(a){a.f_alumno=$("#f-alumno").val(),a.f_tipo=$("#f-tipo").val(),a.f_inicio=$("#f-fecha-inicio").val(),a.f_fin=$("#f-fecha-fin").val(),a.f_estatus=$("#f-estatus").val()}};table=initCustomDataTable("#recibos",a,[{data:null,title:"#"},{data:null,title:"Folio",render:a=>"REC-"+a.folio},{data:"alumno",title:"Alumno"},{data:"monto_total",title:"Monto"},{data:null,title:"Pagado",render:function(a){return parseFloat(a.monto_total)-parseFloat(a.saldo_pendiente)}},{data:"saldo_pendiente",title:"Saldo"},{data:null,title:"tipo",render:function(a){return 1==a.tipo?"Contado":2==a.tipo?"Parcial":"Indefinido"}},{data:"ciclo",title:"Ciclo escolar"},{data:"fecha_registro",title:"Fecha - hora"},{data:null,title:"Estatus",render:a=>{let e="";return 1==a.estatus?e='<span class="badge bg-info">Emitido</span>':0==a.estatus?e='<span class="badge bg-secondary">Cancelado</span>':2==a.estatus?e='<span class="badge" style="background-color:orange;">Abonado</span>':3==a.estatus?e='<span class="badge bg-success">Pagado</span>':4==a.estatus?e='<span class="badge bg-danger">Vencido</span>':5==a.estatus?e='<span class="badge bg-warning">Condonado</span>':6==a.estatus?e='<span class="badge bg-dark">Pendiente</span>':7==a.estatus&&(e='<span class="badge bg-light">Verificando</span>'),e}},{data:"comentario",title:"Comentario"},{data:null,title:"Opciones",render:function(a){let e=a.estatus?1:2,t=a.estatus?"fa-ban":"fa-rotate-left",n=a.estatus?"btn-warning":"btn-info",o=a.estatus?"Cancelar recibo":"Descancelar recibo";return`\n              <div class='row'>\n                <div class='col-12 col-md-12'>\n                  <div class="btn" style="background-color:tomato; color:white;" onclick="mostrarRecibo(${a.id})">\n                    <i class="fa-solid fa-file-pdf"></i>\n                  </div>\n                  <div class="btn btn-primary" onclick="editarRecibo(${a.id},${a.folio}, false)">\n                     <i class="fa-solid fa-pen-to-square"></i>\n                  </div>\n                  <div class="btn ${n}" onclick="cancelarRecibo(${a.id}, ${e})" alt="${o}">\n                    <i class="fa-solid ${t}"></i>\n                  </div> \n                </div>\n              </div>`}}]),GeneralEventListener("btn-buscar","click",(function(){table.ajax.reload(null,!1)}))})),$("#f-alumno").on("shown.bs.select",(function(){$(".bs-searchbox input").off("keyup.miEvento").on("keyup.miEvento",(function(a){if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter","Tab","Escape"].includes(a.key))return;clearTimeout(debounceTimer);const e=$(this).val().trim();e&&(debounceTimer=setTimeout((()=>{buscarAlumno(e)}),400))}))})),window.mostrarRecibo=mostrarRecibo,window.cancelarRecibo=cancelarRecibo,window.editarRecibo=editarRecibo;