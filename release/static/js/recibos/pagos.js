import{GeneralEventListener}from"../utils/listeners.js";import{retornarRecibo}from"./actualizar-recibo.js";import{estilizarBordes,tabla_pagos}from"./actualizar-recibo.js";const Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});function nuevoPago(){const e=document.getElementById("contenedor-ids-recibo"),a=e.dataset.idRecibo,o=e.dataset.folioInterno,t=document.getElementById("saldo-pendiente"),n=document.getElementById("restante");let l,s;Swal.fire({title:"Nuevo pago REC-"+o,html:'\n        <div class="container">\n        <div class="row">\n            <div class="col-12">\n                <label>Forma de pago</label>\n                <select id="forma-pago" class="mt-2 form-control selectpicker"\n                        placeholder="Selecciona una forma de pago"\n                        data-live-search="true"\n                        multiple>\n                    <option value="Efectivo">Efectivo</option>\n                    <option value="Tarjeta">Tarjeta</option>\n                    <option value="Transferencia">Transferencia</option>\n                    <option value="Deposito">Deposito</option>\n                    <option value="Cheque">Cheque</option>\n                </select>\n                <small id="small_forma-pago" style="color:tomato;"></small>\n            </div>\n    \n            <div class="col-12 col-md-12">\n                <div class="row mt-3">\n                    <div class="col-12">\n                        <div class="area-formas-pago mb-3" id="area-formas-pago">\n                            <label><b>Montos de la forma de pago</b></label><br>\n                            <div class="row mt-3" id="lista-formas-pago">\n                                <div class="col-12 text-center">\n                                    Sin formas de pago seleccionadas\n                                </div>\n                            </div>\n                        </div>\n                        <small id="small_area-formas-pago" style="color:tomato;"></small>\n                    </div>\n                </div>\n            </div>\n            <div class="col-12 mt-4">\n                <div class="row">\n                    <div class="col-12">\n                        <h3>ðŸ“Š Resumen de Pago</h3>\n                    </div>\n                    <div class="row mb-4">\n                    <div class="col-md-4">\n                        <label>Monto:</label>\n                        <input type="text" class="form-control" id="monto-sumatoria-pagos" readonly placeholder="0.00">\n                        <small id="small_monto-sumatoria-pagos" style="color:tomato;"></small>\n\n                    </div>\n                    <div class="col-md-4">\n                        <label>Importe total:</label>\n                        <input type="text" class="form-control" id="importe-total-pagos" readonly placeholder="0.00">\n                    </div>\n                    <div class="col-md-4">\n                        <label>Restante:</label>\n                        <input type="text" class="form-control" id="restante-pagos" readonly placeholder="0.00">\n                    </div>\n                    </div>\n                    <hr>\n                   \n            </div>\n            <div class="col-12 mt-4">\n                <label class="mb-2" for="comentarios">ðŸ’¬ Comentarios</label>\n                <textarea class="form-control" id="comentarios" rows="3" placeholder="AÃ±ade comentarios adicionales sobre el pago"></textarea>\n                </div>\n            </div>\n    </div>\n        ',height:"300px",didOpen:function(){let e=document.getElementById("area-formas-pago");const a=Swal.getPopup();$("#forma-pago").selectpicker({dropdownParent:a});let o=retornarRecibo();$("#importe-total-pagos").val(o.monto_total),$("#restante-pagos").val(o.saldo_pendiente);const t=document.getElementById("forma-pago");t&&t.addEventListener("change",setearFormaPago),e.addEventListener("keyup",(e=>{e.target.matches(".input-forma-pago")&&setearMonto(e)}))},preConfirm:()=>{if(0==$("#forma-pago").val().length)Swal.showValidationMessage("\n                Selecciona al menos una forma de pago.\n              ");else{const e=parseFloat(document.getElementById("monto-sumatoria-pagos").value);e>parseFloat(document.getElementById("restante-pagos").value)?Swal.showValidationMessage("\n                    La suma no puede ser mayor que el restante.\n                  "):e<=0&&Swal.showValidationMessage("\n                    La suma no puede ser igual o menor a 0.\n                  ")}},confirmButtonText:"Registrar",cancelButtonText:"Cancelar",showCancelButton:!0,showCloseButton:!0}).then((e=>{if(e.isConfirmed){s=$("#forma-pago").val(),l=document.getElementById("comentarios").value;const e=new FormData;e.append("id_recibo",a),e.append("formas_pago",s),e.append("comentarios",l),s.length>0&&s.forEach((a=>{let o=$("#f_"+a).val();e.append(a,o)})),Swal.fire({title:"Â¿Confirmas realizaciÃ³n del pago?",confirmButtonText:"Realizar",cancelButtonText:"Cancelar",showCloseButton:!0,showCancelButton:!0}).then((a=>{a.isConfirmed&&($.ajax({type:"POST",url:BASE_URL+"api/recibos.php?tipo=realizar_pago",data:e,processData:!1,contentType:!1,dataType:"json",beforeSend:function(){console.log("â³ beforeSend ejecutado")},success:function(e){if(e.estatus){Swal.fire({title:e.mensaje,icon:"success",confirmButtonText:"Entendido",showCloseButton:!0}),t.value=e.data.nuevo_saldo,n.value=e.data.nuevo_saldo,document.getElementById("pagado").value=parseFloat(e.data.recibo.monto_total)-parseFloat(e.data.recibo.saldo_pendiente);const a=$("#estatus");a.val(e.data.recibo.estatus),a.selectpicker("refresh"),tabla_pagos.ajax.reload(null,!1),0==e.data.recibo.saldo_pendiente&&document.getElementById("btn-nuevo-pago").classList.add("d-none")}else Swal.fire({title:e.mensaje,icon:"error",confirmButtonText:"Entendido",showCloseButton:!0})},error:function(e,a,o){console.error("âŒ ERROR:",{xhr:e,status:a,error:o}),console.error("Response text:",e.responseText)},complete:function(){console.log("ðŸ AJAX completado (success o error)")}}),console.log("ðŸ“¡ AJAX llamado (despuÃ©s de $.ajax)"))}))}}))}GeneralEventListener("btn-nuevo-pago","click",nuevoPago);export function cancelarPago(e,a){const o=new FormData;o.append("id_pago",e),o.append("tipo_cancelacion",a);const t=document.getElementById("saldo-pendiente"),n=document.getElementById("restante"),l=$("#estatus");Swal.fire({title:"Â¿Confirmas cancelaciÃ³n del pago?",confirmButtonText:"Cancelar",cancelButtonText:"Mejor no",showCloseButton:!0,showCancelButton:!0}).then((e=>{e.isConfirmed&&$.ajax({type:"POST",url:BASE_URL+"api/recibos.php?tipo=cancelar_pago",data:o,processData:!1,contentType:!1,dataType:"json",success:function(e){e.estatus?(Toast.fire({icon:"success",title:e.mensaje}),t.value=e.data.saldo_pendiente,n.value=e.data.saldo_pendiente,e.data.saldo_pendiente>0&&document.getElementById("btn-nuevo-pago").classList.remove("d-none"),l.val(e.data.estatus),document.getElementById("pagado").value=parseFloat(e.data.monto_total)-parseFloat(e.data.saldo_pendiente),l.selectpicker("refresh"),tabla_pagos.ajax.reload(null,!1)):Toast.fire({icon:"error",title:e.mensaje})}})}))}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))}function setearFormaPago(){let e=$("#forma-pago").val(),a=$("#area-formas-pago");$("#monto-sumatoria-pagos").val(""),a.empty(),e.length>0?(a.append('\n        <label><b>Montos de la forma de pago</b></label><br>\n        <div class="row mt-3" id="lista-formas-pago"></div>'),e.forEach((e=>{$("#lista-formas-pago").append(`\n                <div class="col-12 col-md-6 mb-2">\n                    <div class="row mb-1" style="vertical-align:middle !important;">\n                        <div class="col-1">\n                            <img src="${BASE_URL}/static/img/formas_pago/${e}.png" style="width: 30px">\n                        </div>\n                        <div class="col-10" style="margin-left: 7px; vertical-align:middle !important;">\n                            <label>${e}</label>\n                        </div>\n                    </div>\n                    <input class="form-control input-forma-pago" id="f_${e}" type="number" placeholder="0.00">\n                </div>\n            `)})),estilizarBordes("forma-pago","",!0),estilizarBordes("monto-sumatoria-pagos","",!1)):(estilizarBordes("forma-pago","Selecciona al menos una forma de pago",!1),a.append('\n        <label><b>Montos de la forma de pago</b></label><br>\n\n        <div class="row mt-3" id="lista-formas-pago">\n            <div class="col-12 col-md-12 text-center">\n                Sin formas de pago seleccionadas\n           </div>\n        </div>\n        '))}function setearMonto(e){let a=document.getElementById("area-formas-pago").querySelectorAll('input[type="number"]'),o=(parseFloat($("#importe-total-pagos").val()),parseFloat($("#restante-pagos").val())),t=0;a.forEach((e=>{let a=parseFloat(e.value)||0;t+=parseFloat(a)})),$("#monto-sumatoria-pagos").val(t),t>0&&t<=o?(estilizarBordes("monto-sumatoria-pagos","",!0),estilizarBordes("area-formas-pago","",!0)):t<=0?(estilizarBordes("area-formas-pago","",!1),estilizarBordes("monto-sumatoria-pagos","La suma no puede ser igual o menor a 0.",!1)):t>o&&(estilizarBordes("area-formas-pago","",!1),estilizarBordes("monto-sumatoria-pagos","La suma no puede ser mayor al restante.",!1))}