import{DataTableListener,GeneralEventListener}from"../utils/listeners.js";cargarPermisosUsuario(),GeneralEventListener("btn-agregar-permiso","click",modalAgregarPermisoUsuario);let id_usuario=ID_USER;function ejecutarAjaxPermiso(e){$.ajax({type:"post",url:BASE_URL+"./api/permisos.php?tipo=gestion_permiso_individual",data:e,dataType:"json",success:function(s){s.estatus?(Toast.fire({icon:"success",title:s.mensaje}),cargarPermisoIndividual(s.data,e.accion)):Toast.fire({icon:"warning",title:s.mensaje})},error:function(){alert("Error de conexión con el servidor")}})}function cargarPermisosUsuario(){const e=$("#area-permisos");e.empty().append('\n          <div class="row">\n              <div class="col-12 text-center">\n                  <dotlottie-wc\n                      class="m-auto"\n                      src="https://lottie.host/16abd1c5-90bb-4e18-b98b-a616ac4b71ff/Y552obLciD.lottie"\n                      style="width: 120px;height: 120px"\n                      autoplay\n                      loop></dotlottie-wc>\n              </div>\n          </div>\n      '),setTimeout((()=>{$.ajax({type:"post",url:BASE_URL+"api/permisos.php?tipo=permisos_usuario",data:{id_usuario:id_usuario},dataType:"json",success:function(s){if(s.estatus){e.empty();const i=s.data.reduce(((e,s)=>{const i=s.id_categoria||0;return e[i]||(e[i]={nombre:s.categoria??"General",permisos:[]}),e[i].permisos.push(s),e}),{});e.html("");const o={SELECT:"eye",CREATE:"plus-circle",UPDATE:"edit",CANCEL:"trash-2"};Object.entries(i).forEach((([s,i])=>{const a=`collapse_categoria_${s}`;i.permisos.sort(((e,s)=>e.bandera-s.bandera));let r="";i.permisos.forEach((e=>{let s=null==e.valor_rol?"#47BAB6":"#51AFF7";s=null==e.valor_user?s:"#48D1CC";let i=null==e.rol?"":e.rol,a=null==e.rol?"No tiene permiso":"Hereda de: ",t="",n="",l="";0==e.valor_usuario&&1==e.valor_rol?(t="switch-rojo",s="tomato",a="Permiso den.",i="Denegado",n=""):1==e.valor_rol?(t="switch-azul",s="#51AFF7",n="checked",l="d-none"):1==e.valor_usuario?(t="switch-verde",s="#48D1CC",a="Permiso esp.",i="Concedido",n="checked"):(t="switch-gris",l="d-none"),r+=`\n                      <li class="list-group-item ps-4">\n                          <div class="row">\n                              <div class="col-6 col-md-7">\n                               <i data-feather="${o[e.tipo]??"help-circle"}"></i>\n  \n                                  <strong>${e.permiso}</strong>\n                                  <br>\n                                  <small class="text-muted">${e.descripcion}</small>\n                              </div>\n                              <div class="col-6 col-md-5">\n                                  <div class="row">\n                                        <div class="col-md-3 col-12">\n                                            <label id="l${e.id}" class="switch ${t} mr-2 mt-2">\n                                                <input type="checkbox"\n                                                    class="permiso-switch" \n                                                    id="p${e.id}"\n                                                    data-idreg="${e.id_registro_pu}"\n                                                    data-permiso="${e.id}"\n                                                    ${n}>\n                                                <span class="slider" id="s${e.id}"></span>\n                                            </label>\n                                        </diV>\n                                        <div id="tag_${e.id}" class="col-md-3 col-12">\n                                            <span style="font-size:12px" class="text-center">${a}</span><br>\n                                            <h5 class="text-center"><span class="badge" style="background-color:${s};">${i}</span></h5>   \n                                        </diV>\n                                        <div id="btn_reset_${e.id}" class="col-md-4 col-12">\n                                            <div data-permiso="${e.id}" class="btn mt-1 ${l} btn-reset-permiso" style="margin-left:1rem !important; background-color:tomato; color: white;"><i class="fa-solid fa-rotate-left"></i></div>\n                                        </diV>\n                                  </div>\n                                </div>\n                          </div>\n                      </li>\n                  `,1==e.valor_rol&&document.getElementById("p"+e.id)})),e.append(`\n                  <div class="col-12 mb-3">\n                      <ul class="list-group list-group-flush">\n          \n                          <li class="list-group-item d-flex align-items-center py-2"\n                              data-bs-toggle="collapse"\n                              href="#${a}"\n                              role="button"\n                              aria-expanded="false"\n                              aria-controls="${a}">\n                              <i class="align-middle" data-feather="chevron-right"></i>\n                              <strong class="fs-4">${i.nombre}</strong>\n                          </li>\n          \n                          <div class="collapse" id="${a}">\n                              <div class="card card-body p-0">\n                                  <ul class="list-group list-group-flush">\n                                      ${r}\n                                  </ul>\n                              </div>\n                          </div>\n          \n                      </ul>\n                  </div>\n              `)})),feather.replace()}else e.empty(),e.append('\n            <div class="col-12 mb-3 text-center m-auto">\n                    <div>\n                     <img src="./img/empty.png" style="width: 80px">\n                     <span style="color: gray; margin-top: 3rem;">Sin permisos encontrados<span>\n                     </div>\n            </div>          \n            \n            ')}})}),1400)}function modalAgregarPermisoUsuario(){$.ajax({type:"post",url:BASE_URL+"./api/permisos.php?tipo=ver_lista_permisos_faltantes",data:{id_usuario:id_usuario},dataType:"json",success:function(e){e.estatus&&Swal.fire({title:"Agregar permiso",html:'\n                <div class="container">\n                    <div class="row">\n                        <div class="col-12" id="contenedor-agregar-permiso">\n                            <label for="ids_permisos">Permiso</label>\n                            <select id="ids_permisos"\n                                    class="form-control"\n                                    multiple>\n                            </select>\n                        </div>\n                    </div>\n                </div>\n                ',didOpen:()=>{if(e.estatus){const s=e.data.reduce(((e,s)=>{const i=s.id_categoria||0;return e[i]||(e[i]={nombre:s.categoria??"General",permisos:[]}),e[i].permisos.push(s),e}),{}),i=$("#ids_permisos");Object.entries(s).forEach((([e,s])=>{let i="";s.permisos.sort(((e,s)=>e.bandera-s.bandera)),s.permisos.forEach((e=>{i+=`\n                                   <option value="${e.id}">${e.descripcion}</option> \n                                `})),$("#ids_permisos").append(`\n                            <optgroup label="${s.nombre}">\n                            ${i}\n                            </optgroup>\n                            `)})),i.selectpicker({container:".swal2-popup",liveSearch:!0,actionsBox:!0,noneSelectedText:"Seleccione un permiso"})}},confirmButtonText:"Registrar",showCloseButton:!0}).then((e=>{if(e.isConfirmed){agregarPermisoUsuario($("#ids_permisos").val())}}))}})}function agregarPermisoUsuario(e){$.ajax({type:"post",url:BASE_URL+"./api/permisos.php?tipo=agregar_permiso_usuario",data:{ids_permisos:e,id_usuario:id_usuario},dataType:"json",success:function(e){e.estatus&&(Swal.fire({icon:"success",title:"Se insertaron permisos correctamente"}),cargarPermisosUsuario())}})}function cargarPermisoIndividual(e,s){let i=e.id_permiso,o=e.switch,a="#ced4da",r=$("#tag_"+i),t=$("#btn_reset_"+i),n="No tiene permiso",l="",c="d-none";1==o?(a="#48D1CC",n="Permiso esp.",l="Concedido",c=""):2==o?(a="#51AFF7",n="Hereda de",l=e.nombre_rol,c="d-none","actualizar"==s&&$("#l"+i).removeClass("switch-rojo")):3==o&&(a="tomato",n="Permiso den.",l="Denegado",c=""),0==o&&"reset"==s&&(document.getElementById("p"+i).checked=!1),2==o&&"reset"==s&&(document.getElementById("p"+i).checked=!0,c="d-none"),r.empty().append(`\n    <span style="font-size:12px" class="text-center">${n}</span><br>\n    <h5 class="text-center"><span class="badge" style="background-color:${a};">${l}</span></h5>   \n    `),t.empty().append(`\n    <div data-permiso="${i}" class="btn mt-1 ${c} btn-reset-permiso" style="margin-left:1rem !important; background-color:tomato; color: white;"><i class="fa-solid fa-rotate-left"></i></div>\n    `),$("#s"+i).css("background-color",a)}$(document).on("change",".permiso-switch",(function(){const e=$(this),s=e.data("permiso"),i=(e.data("idreg"),e.is(":checked")?1:0);ejecutarAjaxPermiso({accion:"actualizar",id_usuario:id_usuario,id_permiso:s,valor:i})})),$(document).on("click",".btn-reset-permiso",(function(){const e=$(this).data("permiso");confirm("¿Deseas restablecer este permiso y heredar el valor del rol?")&&ejecutarAjaxPermiso({accion:"reset",id_usuario:id_usuario,id_permiso:e})}));const Toast=Swal.mixin({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.addEventListener("mouseenter",Swal.stopTimer),e.addEventListener("mouseleave",Swal.resumeTimer)}});